<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CPQI - Survey Verwaltung</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .admin-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        .admin-table th { background: #2c3e50; color: white; padding: 10px 12px; text-align: left; font-size: 0.9em; }
        .admin-table td { padding: 8px 12px; border-bottom: 1px solid #e0e0e0; vertical-align: middle; }
        .admin-table tr:hover { background: #f8f9fa; }
        .admin-table input[type="text"] { width: 100%; padding: 5px 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 0.95em; }
        .admin-table input[type="date"] { padding: 4px 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 0.95em; }
        .admin-table input[type="radio"],
        .admin-table input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
        .admin-table .col-id { width: 50px; text-align: center; color: #999; }
        .admin-table .col-active { width: 60px; text-align: center; }
        .admin-table .col-test { width: 60px; text-align: center; }
        .admin-table .col-del { width: 50px; text-align: center; }
        .admin-table .col-date { width: 140px; }
        .admin-table .col-count { width: 70px; text-align: center; }
        .btn-row { display: flex; gap: 10px; margin: 20px 0; }
        .btn-danger { background: #e74c3c; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 0.95em; }
        .btn-danger:hover { background: #c0392b; }
        .btn-danger:disabled { background: #ccc; cursor: not-allowed; }
        .status-bar { padding: 10px 15px; border-radius: 8px; margin: 15px 0; display: none; font-size: 0.95em; }
        .status-bar.success { display: block; background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status-bar.error { display: block; background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .participant-badge { background: #eee; color: #555; padding: 2px 8px; border-radius: 10px; font-size: 0.85em; }
        .participant-badge.has-data { background: #049fd9; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <img src="img/cisco.png" alt="Cisco Logo" style="height: 56px; margin-bottom: 12px; display: block; margin-left: auto; margin-right: auto;">
            <h1><span class="cisco-blue">CPQI</span> - Survey Verwaltung</h1>
            <p class="subtitle">Erhebungen anlegen, bearbeiten und löschen</p>
        </header>

        <div class="wizard-container" style="min-height: 0; position: relative;">
            <div id="status-bar" class="status-bar"></div>

            <table class="admin-table" id="survey-table">
                <thead>
                    <tr>
                        <th class="col-id">ID</th>
                        <th>Name</th>
                        <th class="col-date">Start</th>
                        <th class="col-date">Ende</th>
                        <th class="col-active">Aktiv</th>
                        <th class="col-test">Test</th>
                        <th class="col-count">n</th>
                        <th class="col-del">Löschen</th>
                    </tr>
                </thead>
                <tbody id="survey-tbody"></tbody>
            </table>

            <div class="btn-row">
                <button type="button" id="btn-save" class="btn btn-primary">Speichern</button>
                <button type="button" id="btn-add" class="btn btn-secondary">Neue Survey</button>
                <button type="button" id="btn-delete" class="btn-danger" disabled>Markierte löschen</button>
            </div>

            <div class="author-signature">Dr. Ralf Korell, <script>document.write(new Date().getFullYear())</script></div>
        </div>
    </div>

    <!-- Login Modal (identisch zu score_analyse.html) -->
    <div id="login-modal" class="modal-overlay" style="display: none; background: rgba(0,0,0,0.9); z-index: 5000;">
        <div class="modal-content-large" style="max-width: 400px; text-align: center;">
            <h2 class="modal-headline">Anmeldung erforderlich</h2>
            <p style="margin-bottom: 20px;">Bitte geben Sie das Passwort ein, um auf die Verwaltung zuzugreifen.</p>
            <form id="login-form" autocomplete="off">
                <div class="form-group" style="margin-bottom: 20px;">
                    <input type="password" id="login-password" name="password" placeholder="Passwort" style="text-align: center; font-size: 1.2em;" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Anmelden</button>
                <p id="login-error" class="text-danger-bold" style="margin-top: 15px; display: none;"></p>
            </form>
        </div>
    </div>

    <script>
    /*
      Datei: survey_admin.html (inline script)
      Zweck: Survey-Verwaltung (CRUD)
      # Created: 2026-02-13 - AP 49
    */
    (function() {
        let csrfToken = null;
        let surveys = [];

        // --- Login ---
        function showLoginModal() {
            document.getElementById('login-modal').style.display = 'flex';
            document.getElementById('login-password').focus();
        }

        document.getElementById('login-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const pw = document.getElementById('login-password').value;
            const errEl = document.getElementById('login-error');
            fetch('php/login.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password: pw })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    errEl.textContent = data.error || 'Login fehlgeschlagen';
                    errEl.style.display = 'block';
                }
            })
            .catch(() => {
                errEl.textContent = 'Verbindungsfehler';
                errEl.style.display = 'block';
            });
        });

        // --- Status-Meldungen ---
        function showStatus(msg, type) {
            const bar = document.getElementById('status-bar');
            bar.textContent = msg;
            bar.className = 'status-bar ' + type;
            if (type === 'success') {
                setTimeout(() => { bar.style.display = 'none'; }, 3000);
            }
        }

        // --- Daten laden ---
        function loadSurveys() {
            // CSRF-Token via get_data.php holen
            fetch('php/get_data.php')
                .then(r => r.json())
                .then(data => {
                    if (data.auth_status && data.auth_status.enabled && !data.auth_status.logged_in) {
                        showLoginModal();
                        return;
                    }
                    if (data.csrf_token) csrfToken = data.csrf_token;

                    // Survey-Daten mit Teilnehmerzahl laden
                    return fetch('php/survey_admin.php');
                })
                .then(r => r ? r.json() : null)
                .then(data => {
                    if (!data) return;
                    if (data.error) {
                        if (data.login_required) { showLoginModal(); return; }
                        showStatus(data.error, 'error');
                        return;
                    }
                    surveys = data.surveys || [];
                    renderTable();
                })
                .catch(err => showStatus('Fehler beim Laden: ' + err.message, 'error'));
        }

        // --- Tabelle rendern ---
        function renderTable() {
            const tbody = document.getElementById('survey-tbody');
            tbody.innerHTML = '';

            surveys.forEach(s => {
                const tr = document.createElement('tr');
                const hasData = s.participant_count > 0;

                tr.innerHTML = `
                    <td class="col-id">${s.id}</td>
                    <td><input type="text" data-id="${s.id}" data-field="name" value="${escapeAttr(s.name)}"></td>
                    <td class="col-date"><input type="date" data-id="${s.id}" data-field="start_date" value="${s.start_date || ''}"></td>
                    <td class="col-date"><input type="date" data-id="${s.id}" data-field="end_date" value="${s.end_date || ''}"></td>
                    <td class="col-active"><input type="radio" name="is_active" data-id="${s.id}" ${s.is_active ? 'checked' : ''}></td>
                    <td class="col-test"><input type="checkbox" data-id="${s.id}" data-field="test_mode" ${s.test_mode ? 'checked' : ''}></td>
                    <td class="col-count"><span class="participant-badge ${hasData ? 'has-data' : ''}">${s.participant_count}</span></td>
                    <td class="col-del"><input type="checkbox" class="del-check" data-id="${s.id}" data-count="${s.participant_count}" data-name="${escapeAttr(s.name)}"></td>
                `;
                tbody.appendChild(tr);
            });

            updateDeleteButton();
        }

        function escapeAttr(str) {
            return String(str).replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }

        // --- Tabellendaten auslesen ---
        function collectTableData() {
            const rows = [];
            const tbody = document.getElementById('survey-tbody');
            const trs = tbody.querySelectorAll('tr');

            trs.forEach(tr => {
                const nameInput = tr.querySelector('input[data-field="name"]');
                const id = parseInt(nameInput.dataset.id);
                const startInput = tr.querySelector('input[data-field="start_date"]');
                const endInput = tr.querySelector('input[data-field="end_date"]');
                const activeRadio = tr.querySelector('input[name="is_active"]');
                const testCheck = tr.querySelector('input[data-field="test_mode"]');

                rows.push({
                    id: id,
                    name: nameInput.value,
                    start_date: startInput.value || null,
                    end_date: endInput.value || null,
                    is_active: activeRadio.checked,
                    test_mode: testCheck.checked
                });
            });
            return rows;
        }

        // --- Speichern ---
        document.getElementById('btn-save').addEventListener('click', function() {
            const data = collectTableData();

            fetch('php/survey_admin.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'save', surveys: data, csrf_token: csrfToken })
            })
            .then(r => r.json())
            .then(result => {
                if (result.success) {
                    showStatus('Änderungen gespeichert.', 'success');
                    loadSurveys();
                } else {
                    showStatus(result.error || 'Fehler beim Speichern.', 'error');
                }
            })
            .catch(err => showStatus('Fehler: ' + err.message, 'error'));
        });

        // --- Neue Survey ---
        document.getElementById('btn-add').addEventListener('click', function() {
            const name = prompt('Name der neuen Survey:');
            if (!name || !name.trim()) return;

            fetch('php/survey_admin.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'create', name: name.trim(), csrf_token: csrfToken })
            })
            .then(r => r.json())
            .then(result => {
                if (result.success) {
                    showStatus('Neue Survey angelegt (ID: ' + result.id + ').', 'success');
                    loadSurveys();
                } else {
                    showStatus(result.error || 'Fehler beim Anlegen.', 'error');
                }
            })
            .catch(err => showStatus('Fehler: ' + err.message, 'error'));
        });

        // --- Löschen ---
        function updateDeleteButton() {
            const checked = document.querySelectorAll('.del-check:checked');
            document.getElementById('btn-delete').disabled = checked.length === 0;
        }

        document.getElementById('survey-tbody').addEventListener('change', function(e) {
            if (e.target.classList.contains('del-check')) updateDeleteButton();
        });

        document.getElementById('btn-delete').addEventListener('click', function() {
            const checked = document.querySelectorAll('.del-check:checked');
            if (checked.length === 0) return;

            const items = Array.from(checked).map(cb => ({
                id: parseInt(cb.dataset.id),
                name: cb.dataset.name,
                count: parseInt(cb.dataset.count)
            }));

            const totalParticipants = items.reduce((sum, i) => sum + i.count, 0);
            let msg = `${items.length} Survey(s) löschen?\n\n`;
            items.forEach(i => {
                msg += `• ${i.name} (${i.count} Teilnehmer)\n`;
            });
            if (totalParticipants > 0) {
                msg += `\n⚠ ACHTUNG: ${totalParticipants} Teilnehmer und alle zugehörigen Bewertungen werden unwiderruflich gelöscht!`;
            }

            if (!confirm(msg)) return;

            // Sequenziell löschen
            const deleteNext = (index) => {
                if (index >= items.length) {
                    showStatus(`${items.length} Survey(s) gelöscht.`, 'success');
                    loadSurveys();
                    return;
                }
                fetch('php/survey_admin.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'delete', id: items[index].id, csrf_token: csrfToken })
                })
                .then(r => r.json())
                .then(result => {
                    if (result.success) {
                        deleteNext(index + 1);
                    } else {
                        showStatus(result.error || 'Fehler beim Löschen.', 'error');
                        loadSurveys();
                    }
                })
                .catch(err => {
                    showStatus('Fehler: ' + err.message, 'error');
                    loadSurveys();
                });
            };
            deleteNext(0);
        });

        // --- Init ---
        loadSurveys();
    })();
    </script>
</body>
</html>
